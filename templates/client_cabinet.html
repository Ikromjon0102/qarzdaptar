{% extends 'base.html' %}

{% block content %}
<div class="d-flex align-items-center mb-4 pt-2">
    <div class="bg-primary bg-opacity-10 text-primary rounded-circle d-flex align-items-center justify-content-center me-3"
        style="width: 50px; height: 50px;">
        <i class="fa-solid fa-user fa-lg"></i>
    </div>
    <div>
        <small class="text-muted text-dark">Xush kelibsiz,</small>
        <h5 class="fw-bold m-0 text-dark">{{ client.full_name }}</h5>
        <a href="{% url 'shop_home' %}" class="btn btn-outline-primary btn-sm text-dark">Do'kon</a>
    </div>
</div>
<div class="mb-3">
    <form method="get" action="." class="position-relative">
        <input type="text"
               name="q"
               value="{{ search_query }}"
               class="form-control form-control-lg rounded-4 ps-5 shadow-sm border-0"
               placeholder="Qidirish..."
               onchange="this.form.submit()"> <i class="fa-solid fa-magnifying-glass position-absolute text-muted"
           style="left: 20px; top: 50%; transform: translateY(-50%);"></i>

        {% if search_query %}
            <a href="{% url 'client_cabinet' %}"
               class="position-absolute text-danger"
               style="right: 20px; top: 50%; transform: translateY(-50%); text-decoration: none;">
               <i class="fa-solid fa-xmark"></i>
            </a>
        {% endif %}
    </form>
</div>

<!--{% if not debts and search_query %}-->
<!--    <div class="text-center py-5 text-muted text-dark">-->
<!--        <i class="fa-solid fa-ghost fa-2x mb-2"></i>-->
<!--        <p>" <b>{{ search_query }}</b> " bo'yicha hech narsa topilmadi.</p>-->
<!--    </div>-->
<!--{% endif %}-->

<div class="app-card text-white mb-4 shadow-lg position-relative overflow-hidden"
    style="background: radial-gradient(circle at top right, #363795, #005C97); border-radius: 16px; padding: 20px;">

    <h6 class="opacity-75 mb-3 text-dark">Joriy balans:</h6>

    <div class="d-flex flex-column">
        <h3 class="fw-bold mb-0">
            {% if total_uzs > 0 %} <span class="text-danger">{{ total_uzs|floatformat:0 }} so'm</span> (Qarz)
            {% elif total_uzs < 0 %} <span class="text-success">
                +{{ total_uzs|stringformat:"+d"|slice:"1:" }} so'm</span>
                (Haq)
                {% else %} 0 so'm {% endif %}
        </h3>

        {% if total_usd != 0 %}
        <h4 class="fw-bold mb-0 mt-1">
            {% if total_usd > 0 %} <span class="text-danger">${{ total_usd|floatformat:2 }}</span>
            {% else %} <span class="text-success">+${{ total_usd|stringformat:"+f"|slice:"1:" }}</span> {% endif %}
        </h4>
        {% endif %}
    </div>
</div>

{#</div>#}

<div class="d-flex justify-content-between align-items-center px-2 mb-3 text-dark">
    <span class="text-muted small fw-bold text-dark"><i class="fa-regular fa-calendar text-dark"></i> Shu oydagi xaridlar:</span>
    <div class="text-end">
        {% if month_uzs > 0 %}
        <span class="badge bg-secondary bg-opacity-10 text-dark border">{{ month_uzs|floatformat:0 }} so'm</span>
        {% endif %}
        {% if month_usd > 0 %}
        <span class="badge bg-success bg-opacity-10 text-success text-dark border border-success">
            ${{ month_usd|floatformat:0 }}</span>
        {% endif %}
        {% if month_uzs == 0 and month_usd == 0 %}
        <span class="text-muted small">Xarid yo'q</span>
        {% endif %}
    </div>
</div>

<hr class="text-muted opacity-25">

<ul class="nav nav-pills nav-fill mb-3 bg-light p-1 rounded-3" id="pills-tab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active rounded-3 fw-bold small" id="pills-all-tab" data-bs-toggle="pill" data-bs-target="#pills-all" type="button">
            Hammasi
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link rounded-3 fw-bold small" id="pills-debt-tab" data-bs-toggle="pill" data-bs-target="#pills-debt" type="button">
            <span class="text-danger">Nasiyalar</span>
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link rounded-3 fw-bold small" id="pills-pay-tab" data-bs-toggle="pill" data-bs-target="#pills-pay" type="button">
            <span class="text-success">To'lovlar</span>
        </button>
    </li>
</ul>

<div class="tab-content" id="pills-tabContent">
<div class="tab-pane fade show active" id="pills-all">
    {% include 'partials/history_list.html' with items=history %}
</div>

<div class="tab-pane fade " id="pills-debt">
    {% for debt in history %}
        {% if debt.transaction_type == 'debt' %}
            {% include 'partials/debt_card.html' %}
        {% endif %}
    {% empty %}
        <p class="text-center text-muted mt-4">Nasiyalar yo'q</p>
    {% endfor %}
</div>

<div class="tab-pane fade" id="pills-pay">
    {% for debt in history %}
        {% if debt.transaction_type == 'payment' %}
            {% include 'partials/payment_card.html' %}
        {% endif %}
    {% empty %}
        <p class="text-center text-muted mt-4">To'lovlar yo'q</p>
    {% endfor %}
</div>

</div>
<div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content rounded-4 border-0 shadow">
            <div class="modal-header border-0 pb-0 justify-content-center">
                <h5 class="modal-title fw-bold" id="modalDate"></h5>
            </div>
            <div class="modal-body text-center">
                <div class="my-3">
                    <i id="modalIcon" class="fa-solid fa-receipt fa-3x opacity-50"></i>
                </div>
                <div class="p-3 bg-light rounded-3 mb-3 text-start text-dark ">
                    <h6 class="text-muted small text-uppercase mb-2 border-bottom pb-1">Tafsilotlar:</h6>
                    <p id="modalItems" class="fw-bold mb-0 text-info" style="white-space: pre-wrap; font-size: 0.95rem; line-height: 1.5;"></p>
                </div>
                <div class="text-center">
                    <small class="text-muted text-dark ">Qiymat:</small>
                    <h4 class="fw-bold mt-1" id="modalSum"></h4>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0 justify-content-center pb-4">
                <button type="button" class="btn btn-secondary w-50 rounded-pill" data-bs-dismiss="modal">Yopish</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let detailModalInstance = null;

    function showDetail(element) {
        // 1. Ma'lumotlarni olish
        const date = element.getAttribute('data-date');
        const items = element.getAttribute('data-items');
        const sumUzs = element.getAttribute('data-uzs');
        const sumUsd = element.getAttribute('data-usd');
        
        // YANGI: Bu to'lovmi yoki qarzmi? (true/false)
        const isPayment = element.getAttribute('data-is-payment') === 'true';

        // 2. Sana va Itemlarni qo'yish
        document.getElementById('modalDate').innerText = date || '';
        document.getElementById('modalItems').innerText = items || '';

        // 3. Summani formatlash
        let totalText = "";
        let prefix = isPayment ? "+" : ""; // To'lov bo'lsa oldiga + qo'yamiz

        if (sumUzs && sumUzs !== '0' && sumUzs !== 'None') {
            totalText += prefix + sumUzs + " so'm";
        }
        if (sumUsd && sumUsd !== '0' && sumUsd !== '0.00' && sumUsd !== 'None') {
            if (totalText) totalText += "  ";
            totalText += prefix + "$" + sumUsd;
        }
        
        // 4. Rang va Ikonkani o'zgartirish (LOGIKA)
        const sumElement = document.getElementById('modalSum');
        const iconElement = document.getElementById('modalIcon');

        if (isPayment) {
            // TO'LOV BO'LSA: YASHIL
            sumElement.className = "fw-bold mt-1 text-success";
            sumElement.innerText = totalText;
            
            iconElement.className = "fa-solid fa-circle-check fa-3x text-success opacity-50 ";
        } else {
            // QARZ BO'LSA: QIZIL
            sumElement.className = "fw-bold mt-1 text-danger";
            sumElement.innerText = totalText;
            
            iconElement.className = "fa-solid fa-receipt fa-3x text-primary opacity-50";
        }

        // 5. Modalni ochish
        const modalElement = document.getElementById('detailModal');
        if (!detailModalInstance) {
            detailModalInstance = new bootstrap.Modal(modalElement);
        }
        detailModalInstance.show();
    }
</script>
{% endblock %}
